<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Income & Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            background: #f5f6fa;
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .back-btn {
            background: #0066ff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }



        .chart-block {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 290px;
        }

        .chart-block:hover {
            box-shadow: 0 8px 28px rgba(0, 102, 255, 0.15);
            transform: translateY(-2px);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #2a2a2a;
            text-align: center;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            display: inline-block;
        }

        canvas {
            width: 60% !important;
            height: 90% !important;
            display: block;
        }

        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }

            .chart-block {
                padding: 14px;
                margin-bottom: 16px;
                margin-top: 16px;
            }

            canvas {
                height: 230px !important;
                width: 80% !important;
            }

            .chart-title {
                font-size: 15px;
            }

            .back-btn {
                padding: 8px 10px;
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.history.back()">←</button>
            <h1>Income & Stats</h1>
        </div>


        <div class="chart-block">
            <div class="chart-title">Total Income</div>
            <canvas id="incomeChart"></canvas>
            <div class="chart-legend" id="incomeLegend"></div>
        </div>
        <div class="chart-block">
            <div class="chart-title">Income by Vehicle Type</div>
            <canvas id="vehicleChart"></canvas>
            <div class="chart-legend" id="vehicleLegend"></div>
        </div>
        <div class="chart-block">
            <div class="chart-title">Monthly Income</div>
            <canvas id="monthlyChart"></canvas>
        </div>
        <div class="chart-block">
            <div class="chart-title">Rides Per Day</div>
            <canvas id="ridesPerDayChart"></canvas>
            <div class="chart-legend" id="ridesPerDayLegend"></div>
        </div>

        <!-- New histogram chart for total distance per day -->
        <div class="chart-block">
            <div class="chart-title">Total Distance Covered Per Day (km)</div>
            <canvas id="distanceChart"></canvas>
            <div class="chart-legend" id="distanceLegend"></div>
        </div>

        <div class="chart-block">
            <div class="chart-title">Carbon Emission Savings</div>
            <canvas id="carbonChart"></canvas>
            <div class="chart-legend" id="carbonLegend"></div>
        </div>
    </div>

    <script>
        // EMISSION CONSTANTS
        const EMISSIONS = {
            car: 120, // grams CO2 per km
            bike: 30  // grams CO2 per km
        };

        // average distance per ride fallback (km)
        const AVERAGE_DISTANCE_KM = 10;

        // Helper to create custom legends
        function createLegend(containerId, labels, colors) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            labels.forEach((label, i) => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `<span class="legend-color" style="background:${colors[i]};"></span>${label}`;
                container.appendChild(div);
            });
        }

        // Helper to format ISO date to YYYY-MM-DD
        function formatDate(isoDate) {
            const d = new Date(isoDate);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Small format helpers
        function formatCurrency(n) {
            return '₹' + (Math.round(n) || 0).toLocaleString();
        }
        function formatGrams(n) {
            return `${Math.round(n || 0)} g`;
        }
        function formatKm(n) {
            return `${Math.round(n || 0)} km`;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const userId = localStorage.getItem('user_id');
            fetch(`http://localhost:3000/api/income-charts?user_id=${userId}`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch');
                    return res.json();
                })
                .then(data => {
                    if (!data || data.error) {
                        throw new Error(data?.error || 'Invalid data received');
                    }

                    // Shared interactive options
                    const sharedInteractive = {
                        interaction: { mode: 'index', intersect: false },
                        hover: { mode: 'nearest', intersect: true },
                        plugins: {
                            tooltip: {
                                enabled: true,
                                mode: 'nearest',
                                callbacks: {
                                    title: items => {
                                        if (!items || !items.length) return '';
                                        return items[0].label ?? '';
                                    },
                                    label: ctx => {
                                        const label = ctx.dataset.label || ctx.dataset.name || '';
                                        const val = (ctx.parsed && (typeof ctx.parsed === 'object')) ? (ctx.parsed.y ?? ctx.parsed) : ctx.parsed;
                                        if (label && label.toLowerCase().includes('income')) return `${label}: ${formatCurrency(val)}`;
                                        if (label && label.toLowerCase().includes('rides')) return `${label}: ${Math.round(val)} rides`;
                                        if (label && label.toLowerCase().includes('km')) return `${label}: ${formatKm(val)}`;
                                        if (label && label.toLowerCase().includes('co₂') || label.toLowerCase().includes('co2') || label.toLowerCase().includes('saved')) return `${label}: ${formatGrams(val)}`;
                                        return label ? `${label}: ${val}` : `${val}`;
                                    }
                                }
                            }
                        },
                        maintainAspectRatio: false,
                        responsive: true,
                        animation: { duration: 450 }
                    };

                    // --- Total Income ---
                    const incomeColors = ['#41b949'];
                    const incomeCanvas = document.getElementById('incomeChart');
                    const incomeChart = new Chart(incomeCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['Total Income'],
                            datasets: [{
                                label: 'Income',
                                data: [data.totalIncome || 0],
                                backgroundColor: incomeColors,
                                borderWidth: 2,
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: { ...sharedInteractive.plugins.tooltip, callbacks: { title: () => 'Total Income', label: ctx => formatCurrency(ctx.parsed) } },
                                legend: { display: false }
                            }
                        }
                    });
                    incomeCanvas.onmousemove = e => {
                        const el = incomeChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                        incomeCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };
                    createLegend('incomeLegend', ['Total Income'], incomeColors);

                    // --- Income by Vehicle Type ---
                    const vehicleColors = ['#41b949', '#0066ff', '#ff9800', '#9c27b0', '#e91e63'];
                    const vehicleCanvas = document.getElementById('vehicleChart');
                    const vehicleChart = new Chart(vehicleCanvas, {
                        type: 'pie',
                        data: {
                            labels: (data.vehicleTypes || []).map(v => v.vehicle_type || 'Unknown'),
                            datasets: [{
                                label: 'Income by Vehicle',
                                data: (data.vehicleTypes || []).map(v => v.total || 0),
                                backgroundColor: vehicleColors,
                                hoverOffset: 6
                            }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: { ...sharedInteractive.plugins.tooltip, callbacks: { title: i => i[0]?.label ?? '', label: c => `${c.label}: ${formatCurrency(c.parsed)}` } },
                                legend: { display: false } // custom legend used
                            }
                        }
                    });
                    vehicleCanvas.onmousemove = e => {
                        const el = vehicleChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                        vehicleCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };
                    createLegend('vehicleLegend', (data.vehicleTypes || []).map(v => v.vehicle_type || 'Unknown'), vehicleColors);

                    // --- Monthly Income ---
                    const monthlyCanvas = document.getElementById('monthlyChart');
                    const monthlyChart = new Chart(monthlyCanvas, {
                        type: 'bar',
                        data: {
                            labels: (data.months || []).map(m => m.month),
                            datasets: [{ label: 'Income', data: (data.months || []).map(m => m.total || 0), backgroundColor: '#0066ff', borderRadius: 6 }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: { ...sharedInteractive.plugins.tooltip, callbacks: { title: i => i[0]?.label ?? '', label: c => `Income: ${formatCurrency(c.parsed.y ?? c.parsed)}` } },
                                legend: { display: false }
                            },
                            scales: { x: { type: 'category', ticks: { font: { size: 12 } } }, y: { beginAtZero: true, ticks: { callback: v => `₹${Math.round(v)}` } } }
                        }
                    });
                    monthlyCanvas.onmousemove = e => {
                        const el = monthlyChart.getElementsAtEventForMode(e, 'nearest', { intersect: false }, false);
                        monthlyCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };
                    createLegend('monthlyLegend', (data.months || []).map(m => m.month), Array((data.months || []).length).fill('#0066ff'));

                    // --- Rides Per Day ---
                    const ridesPerDayCanvas = document.getElementById('ridesPerDayChart');
                    const ridesPerDayChart = new Chart(ridesPerDayCanvas, {
                        type: 'line',
                        data: {
                            labels: (data.ridesPerDay || []).map(r => formatDate(r.date)),
                            datasets: [{
                                label: 'Rides',
                                data: (data.ridesPerDay || []).map(r => r.count || 0),
                                borderColor: '#0066ff',
                                backgroundColor: 'rgba(0,102,255,0.13)',
                                pointRadius: 4,
                                pointHoverRadius: 8,
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: { ...sharedInteractive.plugins.tooltip, callbacks: { title: i => i[0]?.label ?? '', label: c => `Rides: ${Math.round(c.parsed.y ?? c.parsed)}` } },
                                legend: { display: false }
                            },
                            scales: { x: { type: 'category' }, y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                        }
                    });
                    ridesPerDayCanvas.onmousemove = e => {
                        const el = ridesPerDayChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                        ridesPerDayCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };

                    // --- Total Distance Covered Per Day (Histogram) ---
                    // Use server-provided total_distance (km) if present, otherwise fallback to count * AVERAGE_DISTANCE_KM
                    const distanceDates = (data.ridesPerDay || []).map(r => formatDate(r.date));
                    const distancesArr = (data.ridesPerDay || []).map(day => {
                        if (typeof day.total_distance !== 'undefined') return Math.round(day.total_distance || 0);
                        if (typeof day.avg_distance !== 'undefined') return Math.round((day.avg_distance || AVERAGE_DISTANCE_KM) * (day.count || 0));
                        return Math.round((day.count || 0) * AVERAGE_DISTANCE_KM);
                    });

                    const distanceCanvas = document.getElementById('distanceChart');
                    const distanceChart = new Chart(distanceCanvas, {
                        type: 'bar',
                        data: {
                            labels: distanceDates,
                            datasets: [{
                                label: 'Distance (km)',
                                data: distancesArr,
                                backgroundColor: '#9c27b0',
                                borderColor: '#7b1fa2',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: {
                                    ...sharedInteractive.plugins.tooltip,
                                    callbacks: {
                                        title: items => items && items.length ? items[0].label : '',
                                        label: ctx => `Distance: ${formatKm(ctx.parsed.y ?? ctx.parsed)}`
                                    }
                                },
                                legend: { display: false }
                            },
                            scales: {
                                x: { type: 'category', ticks: { autoSkip: true } },
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: v => `${Math.round(v)} km` }
                                }
                            }
                        }
                    });
                    distanceCanvas.onmousemove = e => {
                        const el = distanceChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                        distanceCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };
                    createLegend('distanceLegend', ['Distance (km)'], ['#9c27b0']);

                    // --- Carbon Emission Savings (NEW) ---
                    const dates = (data.ridesPerDay || []).map(r => formatDate(r.date));
                    const emissionsArr = (data.ridesPerDay || []).map(day => {
                        if (typeof day.emission_savings !== 'undefined') return Math.round(day.emission_savings || 0);
                        // fallback: compute using distance if available, else use count * avg-distance
                        const totalKm = (typeof day.total_distance !== 'undefined')
                            ? (day.total_distance || AVERAGE_DISTANCE_KM * (day.count || 0))
                            : ((typeof day.avg_distance !== 'undefined') ? (day.avg_distance * (day.count || 0)) : (AVERAGE_DISTANCE_KM * (day.count || 0)));
                        // assume saved vehicles equals passengers per ride; if passenger_count missing assume 1 saved per ride
                        const savedMultiplier = (day.saved_passenger_count || day.passenger_count) ? (day.saved_passenger_count || day.passenger_count) : 1;
                        // estimate using majority vehicle type or per-day breakdown if present
                        let perKm = EMISSIONS.car;
                        if (Array.isArray(day.breakdown) && day.breakdown.length) {
                            // if breakdown present, sum precisely
                            return Math.round(day.breakdown.reduce((sum, r) => {
                                const isCar = String(r.vehicle_type || '').toLowerCase().includes('car');
                                const base = isCar ? EMISSIONS.car : EMISSIONS.bike;
                                const passengers = r.passenger_count || 1;
                                const dist = r.distance || AVERAGE_DISTANCE_KM;
                                return sum + base * passengers * dist;
                            }, 0));
                        } else {
                            // fallback: use vehicleTypes majority heuristic
                            const assumeCar = (data.vehicleTypes || []).length ? (data.vehicleTypes[0].vehicle_type || '').toLowerCase().includes('car') : true;
                            perKm = assumeCar ? EMISSIONS.car : EMISSIONS.bike;
                            return Math.round(perKm * savedMultiplier * totalKm);
                        }
                    });

                    const carbonCanvas = document.getElementById('carbonChart');
                    const carbonChart = new Chart(carbonCanvas, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'CO₂ Saved',
                                data: emissionsArr,
                                borderColor: '#41b949',
                                backgroundColor: 'rgba(65,185,73,0.12)',
                                pointRadius: 4,
                                pointHoverRadius: 8,
                                fill: true,
                                tension: 0.25
                            }]
                        },
                        options: {
                            ...sharedInteractive,
                            plugins: {
                                ...sharedInteractive.plugins,
                                tooltip: { ...sharedInteractive.plugins.tooltip, callbacks: { title: i => i[0]?.label ?? '', label: c => `Saved: ${formatGrams(c.parsed.y ?? c.parsed)}` } },
                                legend: { display: false }
                            },
                            scales: {
                                x: { type: 'category', ticks: { autoSkip: true } },
                                y: { beginAtZero: true, ticks: { callback: v => `${Math.round(v)}g` } }
                            }
                        }
                    });
                    carbonCanvas.onmousemove = e => {
                        const el = carbonChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                        carbonCanvas.style.cursor = el.length ? 'pointer' : 'default';
                    };
                    createLegend('carbonLegend', ['CO₂ Saved'], ['#41b949']);

                })
                .catch(error => {
                    console.error('Error:', error);
                    document.querySelectorAll('.chart-block').forEach(block => {
                        block.innerHTML = `<p class="error" style="color: #d32f2f; text-align: center; padding: 20px;">
                            Failed to load chart data<br>
                            <small style="opacity:0.7">${error.message}</small>
                        </p>`;
                    });
                });
        });
    </script>
</body>

</html>